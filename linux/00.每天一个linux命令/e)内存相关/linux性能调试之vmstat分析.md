1.性能分析的目的

1）找出系统性能瓶颈（包括硬件瓶颈和软件瓶颈）；

2）提供性能优化的方案（升级硬件？改进系统系统结构？）；

3）达到合理的硬件和软件配置；

4）使系统资源使用达到最大的平衡。（一般情况下系统良好运行的时候恰恰各项资源达到了一个平衡体，任何一项资源的过渡使用都会造成平衡体系破坏，从而造成系统负载极高或者响应迟缓。比如 CPU 过渡使用会造成大量进程等待 CPU 资源，系统响应变慢，等待会造成进程数增加，进程增加又会造成内存使用增加，内存耗尽又会造成虚拟内存使用，使用虚拟内存又会造成磁盘 IO 增加和 CPU 开销增加）

2.影响性能的因素

1）CPU（cpu 的速度与性能很大一部分决定了系统整体的性能，是否使用 SMP）

2）内存（物理内存不够时会使用交换内存，使用 swap 会带来磁盘 I0 和 cpu 的开销）

3）硬盘（存储系统）

a.Raid 技术使用（RAID0, RAID1, RAID5, RAID0+1）

b.小文件读写瓶颈是磁盘的寻址（tps），大文件读写的性能瓶颈是带宽

c.Linux 可以利用空闲内存作文件系统访问的 cache，因此系统内存越大存储系统的性能也越好

4）网络带宽。

3.性能分析的步骤

1) 对资源的使用状况进行长期的监控和数据采集（nagios、cacti）

2）使用常见的性能分析工具（vmstat、top、free、iostat 等)

3）经验积累

a.应用程序设计的缺陷和数据库查询的滥用最有可能导致性能问题

b.性能瓶颈可能是因为程序差/内存不足/磁盘瓶颈，但最终表现出的结果就是 CPU 耗尽，系统负载极高，响应迟缓，甚至暂时失去响应

c.物理内存不够时会使用交换内存，使用 swap 会带来磁盘 I0 和 cpu 的开销

d.可能造成 cpu 瓶颈的问题：频繁执 Perl，php，java 程序生成动态 web；数据库查询大量的 where 子句、order by/group by 排序……

e.可能造成内存瓶颈问题：高并发用户访问、系统进程多，java 内存泄露……

f.可能造成磁盘 IO 瓶颈问题：生成 cache 文件，数据库频繁更新，或者查询大表……

4.vmstat 详细介绍

vmstat：用于监控、显示系统运行过程中的虚拟内存/CPU/磁盘状态。

简单示例（时间间隔 2s，监控 2 次）：

![0](https://note.youdao.com/yws/res/19865/6684251EDEDD43DEBBAF7695F4082F75)

重要字段解释：

r 表示运行队列 (等待运行的进程数)

b 表示阻塞的进程

swpd 虚拟内存已使用的大小

free   空闲的物理内存的大小，我的机器内存总共 8G，剩余 3415M。

in 每秒 CPU 的中断次数，包括时间中断

cs 每秒上下文切换次数，比如系统调用，线程的切换。上下文切换次数过多表示你的 CPU 大部分浪费在上下文切换，导致 CPU 干正经事的时间少了，CPU 没有充分利用，是不可取的。

us 用户 CPU 时间。

sy 系统 CPU 时间，如果太高，表示系统调用时间长，例如是 IO 操作频繁。

id  空闲 CPU 时间，一般来说，id + us + sy = 100。

wt 等待 IO CPU 时间。

典型的问题现象：

1.CPU 问题

a.procs.r 持续有值，且大于系统 CPU 数量，则认为系统不足以支撑当前的负载（因为一直有进程在等待运行），可能是软件实现问题或者需要升级硬件系统

b.cpu.id 持续为 0,表示 CPU 持续忙，需要根据 cpu.sy,cpu.us 继续查找原因

c.cpu.sy,cpu.us 持续高，且 cpu.sy 大于 cpu.us 表示系统频繁在内核态执行，可能存在频繁的或较多的系统调用或者 IO 访问

2.内存问题

a.memory.swpd 数值持续有值，说明系统内存不足且使用了虚拟内存，需要加大内存。

以上就是本文的全部内容，希望对大家的学习有所帮助，也希望大家多多支持脚本之家。
